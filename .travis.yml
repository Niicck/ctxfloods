language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn start-express-server & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn start-express-server & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: zUe1MdHiGqnxWpky32g9S98Uo2qgzCCHCK5Kzk0spk7iu5UvjSSWto2QkNUCHz+HujtrCYemLouJ7LyntlKIO3+nZ1HHuZ5amikXKJYEyOuySPfyshR86gnQCePXvjoWk7BuLLRbob1qLbVxEmCQ1JP+HDQdabhE/8qSDYllOjHk2DTF2K67bt9KRoqP7/i8UyNpb7fU48p76DUsbWD1hId/VfEEjMHG7ZvWb70yXpJKfgwMst63ySgeDTEK9OkT/Au4mFU4fCq3YN5oyNo88DMk8JdFClMHnYJ3Px3+wg3ZcafpxxcmEWuhU3KH+//N1gOD/0F2r740yo5YJKxCbneoy7zkuulnPnCJRE+ddF/Vbr0SLHpLYa7UD0HynodshcARlsj+3vxVv53nsbTnLb/+CeHx1cV0PvcMz/Q2Uj5kunTfd/DY9pU0Gq2+tC4NKizj15/A893f88919H559qPYir+ZSr9SO3w16R5vi4OuPa7nSQQPj0gXf3Tg/+FWBDJqimmFofNrEMKoDm8Y3ln747kEfT0waZjy55l85U4b2qN+3DdAzEePAZl5VPcKuhkziCrBWcGp4b0jDNyeg30YvUU8FfE6ib6tmNLl6LFPfzPEeEEROhuzy3fQCiceOIOU/UL7jPflFkgEZO/+8QNWhgoBBf+Ac9pj0rcuf4w=
  - secure: qzWDOozrnoK4RfTrtSdpeuPMW3xKE5bRN+Yo1ZsJivBiq2Ff0QGcIXyDkR/w/C/MW7LGJyHfbeL3G6WGSoMk40ECxjyPDGLUAYf12c4eZuW6U95T6UyDEWZbHenKGGJMIlGs2IYlXlpIknW1JZLwCOcZPoP/xfzk+yBllXx40TqgfnAQK4TENCJYOWq4wblKS/rzNkB+/Xti1QrKvnHEpSxWHJDAECL26jW8qOPGe/K03ilbMkKmchb3pVqd18/lPfzX8UYhpVDqBD+O55wxwkuGonk3xH5I10Lu98fa8FmoT/KLTJogvizj75Ostuk3G7kqyYqbxcDxCy0SB9Y/pB2wS/b9WmhDt9hk6YpxfJdNw3h7WsO/K+5o04Q15s+InuNRAoF9h+jTVWA9UuzJAKm3Lhg8HGscaNzLRl2Luvy4j6PB3cVeIxjhjMETCFeDwrm1jVdpqDn1J6yl6ZkkmM3gFnHwI77FzqAz7Oumooq9UOED4B/zTgmQu9OKv4hyPsDZ2zE17bd+EqgAeua8h3BfCqfBT+MMnRoRytrX5L5DSQV7NZIINx53g7kKI+YFtJOQQ5nqeT8KEenuOCixXBuKDVTa0TU5OBZoNuu3yPVIGQxAO3X14LBNIyhHsjBI608bgo2Ew0foSIYJk2pOV6dhUzl2LuyLP4LQPuXrhr0=
  - secure: a7xu3eYR5nyTc5auUbbGO6TFULKXiPeDMGkBLhh/0iMcb8J91egngLfZX7jv4JKuwsq9x+9gosmEjX8Azi49w2Dzwi5VXTmp7mzV8IG3lLm0Vr+3QAv51zWj3Bbq1HEt3B3K0+cdwtni7cnuO2g6ZZ/wnR+6ObJBX0jcN2lkVVOhiCLJOX3J2rE9Gq9QBSxB/fZYL0JxoqusWdTAXbZsMbzGetrtwWSinoUlrUARVFE46IEgAUKA4t2By1Eg0HiYw90JF/C6ndvpe1BLeHBDaMYE5P98K3mYqbJeVYuy6FDIRm6hMkN0FVaVeCYMXas5Uu6z8qOCJ/fr8XIXbwsJR7zhjz5Nlr9Iavdpg+aQWeKXdOmtJJrE5KgVxgaQ8IEjLdMr2U0lSjTzYYVtUBp18NRht2fZi1toTPHkYznXPpzNMe+9TWjmYcNXq9mNr/4k/6Mn4GmOmIU8cE0LluUW0jbsyUIhD7Dk+hZibYg0IUwH+6aSZByOHf073gIxFWJQ7/SzDlbHiRLqEHg9vUL7/pRT9IQ899JyxrPXarwudcL+Hooh/4i846xQLKPfqM4gTkusJFYdP+B84Fo1cGT1B8I7PGNloorMzwx19zzmFh8Hn4KvspwwkEAx00jziDeGJpkH42pojFY0CiL1bBoEgG1ob/Y66VhlD7yaNmh1WxM=
  - secure: wB3FV0QeMafNnB/3iQExEyOh0C3pJt6ImAerkQXYi4JJmJAij7AqPN835ttPYkfVAHV+disV1DIlRsW0VZcHcSIKqM64tRVn5vpWjPoqa0mpoLfANp8EYQbi5Y73r/FHN4eo/2Sc+QFGvs/fhLLCaejfMAAY4QNKW+0bmb7dJOt5xm54NC06kDsowaPgrWMm0zRnG5396LUDNiSZcdKqLNhFp+NmBip0wVwZew2HzxHAVFJT+DiF8E2Xg642Z1V6nJTQ/giqtd3dwx7tpoouaWK+svZf+03c+jtbu4ds/68DAEvtm5Cf+INSM94nwQHMKR7WzPGNKyx53gUW/odJT3fmkEtuRfLt9/Pfr9Q49Km2avCikP1A+WsUIsp8MmtaZ2qBhcNc6APg4PXxiTimYFs0joPalV2ulpYcUbh3T+JgQw1PFt8z9DvTNHeLohUMedG0CvFWRcL9BaHxYGrVtDUzEAFFak4VfhCopldpSi1nTR0/MLe921WUsz6JMV1YgQg/LQJ5TYF9Do9T9Q0jYah8ewk0y8BgFWYm2ivz755g/vwIMyKyju/DB1vVEbxi1Tx2mdT7D1Jw5EZyp7xg3yrLeGCcxD9RH2fLljKx9iPOu016Ml0VWf8PykfOA/S6/YT+lrc4C04zryJK/ICTPHWtpb5iRHEhh3UoGqgWULQ=
  - secure: IsPRSxDJj8W/sMWjqzFwIfZxx+v0lQ9IaZaIIzDfNkyhrm3PQyPEhQvMRI2lKPEzm+k7RqnJ8QQSiG0DZhVJY5OfYapz89XJtHblOItHLLN/INHqgsVfJACCIGTcQmfapICmEvSzbqGmPil6gN9+FAGe5WwZi7/A2+aFDbhy0xHEGX9L41+V+nuKHIA0q0deSxDy+gAlPAjrgubYvTmxLhKDUjvmzI2lZBq/4BPTb/xEk6ARtznVMgLptPmjqbkMYwVjKMbuQbsxA+DtxO6oKQuGpA+NCrhEDIRj8VT4s8atYk8LAX8WycPuA6Q1H3pQ18jlQgIsW8DX1OUqWr21QACDQm69RZRYDG9roew9Zm/j2OAl/yqQ6nbkIOfR3nvg1kKGLmV4w8P6tsZkQI6HK8uOZRSY0EF7vi8/x5dOkFgn0XxO+hDXs+5MxmLS+FF0Dv6FVOzu2PTTNGxHMGVcnymIvms4xuvqztHkr1RaARHsdH9hS0D3VvS2mR2OtIcpal/bBteaUFClVCP2dHKI4Ca34mEyqwTaIOv71TFlaG3ovYOgb0qRMJcPmP3ZyN89CKfDmKQ+VPdcIE+MjzVnisDn6wb92Mgj9jvpAyfH9ElwJLyJ8gVAyGHgjlgf4yPtWKZKk/G4zLHe6Td2xzQzaAcBTHwNjf2GLVOxHR/ybec=
  - secure: aXkPSs/I9mRVFygI1LW7dq3Db5hTpmAwcs3uySOMo0BlAtpZgd8lJvjcmDHqTSZezxoGY/0rbFrYlktBQ+KeydObMwJ8XWs+qpxyjDZEh11lGvCWoCqYb4zSneouHGGtRAFOWqw7VvdzCLCY33piI9G4CQ54wVEz0j0XGWLfG84LHpiefRhDPtZD56kb9xOb9PjMaGCJT+MrTDPN/dYuhbPlwB+COzMmk0IlxlDJKR1txFzI7pgQUm4GC1znBuEvo/GeNSQV3FPCxcZ+u5hEF9EwTbjzAU1DfNPkuVsPZ8EFCdjYGya5Nwuq5mr16bqYNNeAf/CGnralQbGcarpox6f4IDSZSO2VogOESscXKuiDCFAxRCmSSeHexyxxYD9n4VdjIMA7uTmQ8AM3CxGcFKTcGRYt9FHicFrekmzVSyy6ljeMAtr+IRgyEfEdduGqSt9/f7G5SRsrULA4bANSHIFpKhEwlz78kZEZexs50DgGvqGFLOq/UED5l43bdcAWJ1VlN+w1cwAeuRr39iW7lbkGfkPjiuBRpyd0SpaA6eYA7RJe37+O+Ruy8QxrMC+bO54Tktbm8Y2Z8Dq8H/JUEadYJxO4Hm8q7zEye3BXdGi+EJ3kbuOATIfnWkQbMBSJ+q4vQzdG3EdbblZbRsb3JiUBECCPRkIsKvjHyNzHZ0M=
  - secure: W5cYXrnXibDwzvqoF6Ey92ARH4OKIzRFdU+CB1tXeMRCtsr/L33BKE92nqMLDV0ncvapklN5+muNZfos7xyoPAbQemj1XqtaRpE7Eo3F/ewpgSZL5SFX3PSTkUNKDOrlFm8jpVEPOi55RxQ8UGlJO5jgVeBR5qvzmh3NiOUtysEUcONxJPO+LLW2+SyYAncpkY37RibqHfZVLshvmB12xMHJl9XtnLtveDlWeNN2CIq2gQDagpTh8lETqs2dUpsfZduexTqRd8kxRNJv5xVKYgR45+nYp7n5YbhRJoZjfLtwg+tE6RfJlLYcc6NWDYBdwFKaHhMzolyYag2wSy9EADFWG5j4tmdJQtytzQSTGIZWeGlMS2eZL1YlN384MdkkF7+MvPMquyGPgA+1MjHgeYzgQfiwHGZWk5Lf3y6hhd4Zv3IjWPYVMGxZsa9ElQNADAftV8RbrInSm9q3UDSXVEwK+uZxg1oDiXR2Il1jqg+z+AuZpNbsciANbBljFMeqkcm4ntBXgMC2QJd25xYq21YeyOmG9WzGJwAGYZipTMgowfNqbfNM3algrXuo31Mt0YPB0tInLs8mrciZXxj8fp2P0j67C+bMtSUFajvxYo97OUlDkej/gzSc//RU5Lmjerln1+rUXIqc7+P39sGd/qm2P6owOwckcTUSDba62nM=
  - secure: fmMslCCYLp/2wstwTBXFFHG+bw5q1Q91/L0YvIgBGyGUDVtZ7lt9LW2F+f5W8gMUvj+gfBy0DFq8XlZaPPnoCemk11QPfnKutcyAL36+k+MLXt8YYBCLfnu+lm1R0M5RniOgXvbIzP4oppwtIIBQZC8D449TJZpUlBG/FrUC0KC//Ds54DN89802/sGaBAe3g6BPVjK6EDmO0ZrYnSzPhQIGAMK9K8Q6EBfL9xvPVp1+nfJp5t5tlXs3/hmLof/NMQYYMPKYkynePf6oH/B5nkfWet3eEMJaSX2A9BbobVHIDxzTvm4Vg2R1L36YzMk+i1a2+ESOssv/hdhRxn0pXTR2zGzx6WGm0sgbx0KhdLVla0Kacz71zQVvDGzlkxZuvzbzqmg7aT7CR3v48fAuVCuEluUL43hGYDlo4HGR9AOhbCIw0ZqRp9n1w2dbKEvylesX2XvPoiG97lj0wwtlos5Rc8XS9+cUXvm6Pgypi3rmPT9OqDo8YRVyN66XzzinJbk5Vpo4sYS/kbar6LHGDDMyNHIx70lD5KehvdXzY3+AC7bM1dK9UwEpeo7cg8fJhaVv3LJXu8A+ZBN2gD/biG00NM8GCtdAhRE5vb7xKxGQZ7aJrnribPD6x64zeiSMrfs7H8dyQRwkigD1tLvod21kpIssSUuFI3r6gqAUiqU=
  - secure: OPoKuAj49x5hFXU3sH+ywI9qlVVAh659qRFbqr0o19nfFgfr6xmtjM3iyNpempc41il/s3fsN8L4iLQcwG5UYRc8WiDXg8DvcR8jClUcrDcy37a4Xog3qcmT2Bkh6FhLvcIiGo8fJ2rfdrZmTTLR/MCytKI6YM8kreerz/EQIVymsODzZmpAjLc2iOxmE9bNiovJpa7GqA3QwobeoAQEWWrZQHFP15VQt+O3GiI6eme+yvAIKJckzbMR1ddJaJLUvyzPgQw3E6jQkiangwJzLmiT8HaLAWA6oEauCtFKw6pr9QOFQ8FekXrVzr+J2+mgHfw4wfOIt41cv7WPtNav4PivacA/w/950nq9UnSjnBHOQXOa97tjgYbNCI8+NHb7pssxyVWq/JagO+1Qn6PtRJb/qPUie0z3Wqcv4mpU4dgKReFvPmmcNux72KJwZTLPOq2QHJxAvXmXoeZZDCWzFVx3Y5yp4Q693wNRzEEeLF9CNM/FEWrtaxB9hjvtillHLZOxOdvkwkWf87vVdjku+D/qz+iMoAOZTbRmoqEGNNmj6uU7EiaUCeIDOBxO39TmRWtAr5qictF7xY1pVhNNvCEH4oP2lJukSfb21r2DRc5CkU/AsKPthKNmL1SNnGoWkMntHjYrgXLk5An/NhX+IZkRpdr+QJGX/ikR0OPDm/k=
  - CURRENT_FLOODS_BRANCH_NAME=master
  - S3_BUCKET=ctxfloods-frontend-master
  - FRONTEND_URL=ctxfloods-frontend-master.s3-website-us-east-1.amazonaws.com
