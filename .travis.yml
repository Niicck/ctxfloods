language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn start-express-server & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn start-express-server & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: LqB1u+uY9EXRjbxL7CrRHWGgNcTxz5MDLj0AZp1FRpuyu3nxReIo24M7SyxdPE3+kjgVQC2isjXbk2fPSFvzusEFB9nZSjm2iJh7Ycu/6NHSLofhAVwBOpIF1xI8nH4U+qT/hLd7Eb9C8hiaBN+n/ec1vU2fwY5Ww02Fh06eXE23zcGcgqStf6wtvB0G3rdvp2SEN6RbkPRb1syt1Q73MpNI4ixsOYS6+z8dGkGuEG8PE3SCyr2We5lnI6dWHQzeHBbMGuwfbBx7o+4rPIzQYE6xpXQW5DXCvgGAPXIq60BDNSOPAlh6R/mp5dahBMSN47lKZAQzccFhYvLR0GmUtVJxOpVPVV5PwzMpfNrxZb17s5zvZ4uCg3y6Ng+vXNrlMubwBh9lSZqTA54VF/B6XD6wpSAEFFNxdn6oGAQwA4nx4WPKdqx7R9JOsZX5fFSlYNDsOCZfOxaFh5YsO+r5TA/Slu0KTv6xyzUDLaZe/Okk+0hABtaCLGCVp/TzKozKUo8LT1KCow+MEL6x2rzSErLgOBk7W3MXYOPCwOmP5g5I0WQjCymsyh674Qa2Z94v4OqhYsuJmOWfmov22CF8N5Q+S7DteZM+1RDv9CJsPQZwU+kV3bbY1scmZ+3rdxrhKm/DqXJ9XYDywkRwZVT+kW7oRzqEUXU12hT40mpbdjs=
  - secure: c05MmeXp95IFsxQWHfDgpDD59MbT60bSo1uim8njqCpFY6q+yZlgQJn/W1DMQybBmaAV7U0V7y20Zt24dg0tq0GbqqQ394bnH8vp/Kflrmp0KuA3veSSVBQzbWaJ964CXzmN0vMm2NCpGi++jmpnVNQRGfjHdv1aU98DIEF8rQPwpeic5T+4ZPk/EpYriUCahhjRjtmqOXWuSTq2zNiYpV+IaVdItNgbclx2BWEcQ8jEaHtpE714lFk9fC1Uh5HtPUMd+RrcDiAzsUohX1GQ6twLazuICGIjeLwxHkpudpBLXvqj/W/VEvEKj8uVqyNwuDIJGUYAtiM2YIxRFf7ZncyrYjXtxVnheIv60sNmpDgPg/Ja3TEnbW0IjCeWyz1md59O2ALpR2qjXFCFCsnp5+i8JmqnXIwwoB8NNZAK+wWB5IxQqIgXcs+C0JHrHA818rRmrBWoC36IQZkJh8l29a7ClnIQiOwM2Xj+Ly/YqjL3/+NLunQm+J4Fw1CLGGQ5lv5HvsJNG5moSdw84TEHRKuGsMHtfI6DMGD/L1nO1ohg8GkbZjn5tvyCD5oXGyFEvfoUCVmjIRxpl/dWnz0umheRzZ9EBoOsu6Y9tX9qfymGgIUtrVvPzKLIOq55irXL4DWfGgSppCmbAYAL5wD7sGWRTFbXLesxEWTKMshOscQ=
  - secure: WYQ6V45gaal1Y660CDcMKNnwYGFf2ZopqMYobDz9C+bSZECZa23BLpH8VoO4wdKdipDdWqh+iPjwq8/jg61mcMouB8kKaJlpjKZx6FD3XhALZdBPqBvzC9LUs6pBjbmNHyrJzr1qyCHJXRpUhMD5n4uw2uuTYm9xEbZfu/GGTocwZRUq5um/C4toVPsTwokhTCDHyAJFBW+OS2+xOx3nkEA4xn53yVbc0YPzLlnk6yggbWlLZAol49f2rCkBUu4ph0oqgJSp2ViTWdpTC1YqfVt74FfRe9ghWJVF/i7ws2noDhMuM3WAxI+9e4+AXTnvjzHXQ9IwysOql97DLSa3cy9Xw85szEXNbKWQydmkGzYdlKR7KKw2pNRZvvGS/idlarLagkBoqCrOGBtkrWhHr7Nn/HwgjG3GCX5vNbSkngBQGCDzwMG8oCcW56zlGjkEivRUy8Roq+9ecGZQeI7sl80bkbTwG6krK/+UMB64o6GNoApfhoDbypUECrS8o2FNWadUTpzC78wc7RpaGV1X715gOARZSZRenr9tNpCy+KdXits86czVTkLTGGMpvnhfKkwe0Jh8TrfyVXgpOTPMyimNHKw/SpZTHJ+hjNKIgQ7gkRMnIOsMZFeOtN+hU4BaMl6WSf7S0c6foitAc9zM0AXxgG/+w+LQ/395eVg5LiM=
  - secure: yS+naQoSCBNAiYzOSHMct2n8mh3E88wiv8Er81lpXuJmsWsJ/yJOUS77iixnAUwbS4OyLp3ixDRMLY9qkFqPPZj98QhfWEuB6yfy/koCIPImOwi7bi2jSNTlLUD8DatkpaakuXJb9xCnrvnaO8vv+8qhN6Cn1Rinw4lJHLdrusnNVU6BYQ3Uv0Ugs8khC6glDX4JAqZ6S/bKTe1G/2acZJ4zNy9h6CqmGHFy+SzbFY7AM/wrqIGG4MvrEQ8CE9l0MdoTBjW4gm5AYVZ/z1ZQ0eV8LGt3sTDSq+fVd5FnvvuzD4LA18CTYhZHwl9rY0smtww6bdeRVIk3X189iJZ6xq/rfc9Jpgz4GUIJ3rl8HxI+2OqUuZfZO0U198opyawUnWnLcAxF8u+bKr9L7loFJxP+jS8DFPQmIfUbW0LPU4LC9fCVsflDpCAEE0tHgPbNEHAkNmedJ2rK2XfRxCThqDqUgbYxKsIwGeMbpsqyMGjdq5SG0o5IRktOgQMyXM8GiwC4eRKGWq/UpYIs/GE0K+ATbz6GdXHYzOFfoESDXlckTlBpLthWnsFaOxoPGp6nlHmTEcEeCBI/4ojCvtowEQ/dCtWRhn1epPCh9s21yuoXeNy0wZd0b8zCJBkvnxYK/Qqt1nespbLSEOpzvSpwNvBxhSlKvgolD5Qn6syxKdg=
  - secure: NmagB3kragi4CvK3xUKwFn3wx9klGk6QzGXnbygLriRh7qUxQTq65D6Q/TAuHoBdJPYJPEEOYhDDQ4pn3TEXNCgdXVHpg/8TBssr+yjQYxDrq2zwH6uiYYyjNJJI35MresmzlLpKuKARUlLG0Q/RK3aAYGG8Rm2wKkz6E5nXvtJJXRDuSuFIkGgeNEgN9GrCPVfZB+/GZFqAO3pUDE8K2QdN+Ngi8gz8MYtzO2HBsyhcKRSJeTtxAPPEdwieRtTlDrh37GyBheuveFQhgDvGJ3KsnTG7ZNvgVOWOF/8W5JsRlfS9R4QEfdZXk5eMezBJg3B8tdxmR/S+W3Vuuh3Ni/aClOBdvJSfb8aHJVsdBVVQuU4g/oxxAwUJ9vnP8fkC+IG1NpYpLpW3zrqtFr4N+JS7OIoIfcU4I10JFdCWAhqjR3giZX6G3AgAL+SMaiLHfnEXZiJajtq+C6h3VBMErbcjd0sVqw22HrF6MjKeyLnTFuedsuNggDVktS2uJRXylaXuwor4ptpvfDufI5bx0pb81T9ZudGgN1MKEkgcOsob7rPPxEqd9k0OkhTrR6JzSWCu9KaxWIscl+PPN9ICRK1rWHuIf9jVXxB7e4RqoLeXHoiyETGi5+jo+NJAKem1GfHOgVUBpRM1+sHVm55ftkmDfedqLNldU/keg5WroKY=
  - secure: gZnoZ3kBRygfuzuUtrDw6UrVOWncNBOemS/6Dl5Wi6nCxfGNsWNb0z2I69G94afWy29mtx7HByeMBOtnXJ0qygNTa5jzdyQNX9dL+mb0a3rVurFjXmBcldmrkEszWlB5LAHhaKfqp6vzHJ8TwNzs+2MAlh2MG3dsOBhSrptGrVlkyTlIF0fDQRHrA2B3IGAY/50PkQ0hdQ5je5BXdVmRr+fIjB8qGwLVyiqPIqDgERcbF8KnDwkP8MUaYQPz15DjDGMpqYTg6TLZOGmnQBlVT86oXBbWOADOIJ+e1JB0RgVEfS23kOOCb9cwtfKrDGymWgh3lbqxbwVAT1SAeYMZmIbfCsK/kxiUnbK6Ftj1qk+WZIoKCI4eKN9FTo4esjg+/O9aFuvd2L9JmjeTZn6Z9uDf5SrKjydUivVRJmLtyWcA8AcSlt1iWeWY+SelVRTIQpATmAhqgvUs+0S9RTw6xtxv9PvO7IzdV9e7ZbA+0smWHayApDXEFaB79jT1tN0HsQTVyp348QT1QF4WNtXA24lf1p+vdM7wvV7jEbHkUm//YpRXYvlnNgYEuTpnR4bydEgH2V9+0TOW5HL61uc/n3hgEVEZME6rWs1Sw+64HBcGummRxpAvdsT6dOrGrCYVAY0SXps7udbG2pX3lVDwJF6NY/AF8URB3NxYCrfHUNg=
  - secure: cLXuHQAbLOBqPBK8bjH5FedNUEr50LA+VVe9tfha/n1lHuxSgRr9LXK1S/Xmkn5uNlMQF0XAyFCYj1shr9qn8TC1JY1RAvAfesyLRD0jSS60PhTuJf1MaVcqe86hZLDfNYl2ivl94jFvCHD/Q1oYTX9bezBewc46cksssokCfZis2A837H1IUDfYJLfKFOOsqZFwKMDCodkDmzVKB+9Eef3uzOf+jv/kIy+92/gIE06nOhaznbcLIzaZIRE0qEPMVAkzVp2tpZWIEUrrDRd8LxysmAIopcz4AUtXDAEk7k2J9vTQlRmE/ADRFcl3nZXAfkCyj1mT0CXyoCO+v+9EGd4n9wi4+cuqxmvd5dXvxxFLultTUL+7vdq6vwGsiJVWXpWyeSOlcTQojo6URVmQSV4+X3qXMd2jFgc7shBYZMJ9Ax+DwyljX0nKAMqe/zhZjIAcoNRbyNuTDm1WBkjYUL3mkQMxnUcKih42Pd7kQKivSIhxM72pKQL+mVSNyMdTe2r/jejlqaVSd5MgKcHmG34terFayI4lI7in7ftWkljQws1KZ4Dr+i7AxyI2Noh4r2Q4a8Ft0qMo6ueRg3rfiuKpngPcV//Pj5+lsot8gDHyV8Xhsh+WeuZfbRcEHIV4p73gFCYvo53/YCzWxGSJEo+pg8DvOXQg2z95FHqwTB0=
  - secure: sAFxaep4k4F1LU8M3vK1isd6zgxGO+uutY7gKGFCtH7Ccd4HLWjNRNmFmZeiexmOFFvlpvgBekOzFagrD0gvu3+94lqcOaj6b41uxl6mp8pfsV0MsbC8TQrEL6P66FSHE1O1eZnEy4lo7xAaXqT1nbJ9znzeobD4pEOTafN2nLHdBls/IqVSDK6mHcwVZvl63h6aalh2wI8Fi3wEuyRvGCUaoz9rjFFHOHgflxsYxOdWvDuxD6Sx6A1oyqYbr55gUCyeHJR5jplrbkLRb8vzv5gTe6zFdiKGphY3utR9Mlq5Vkm9ma4bVmn7tRTf3E8wkZUTWHpfo3Q59NKpYrIJErOvsg4CAPhLyFYk4IY8J2Xnn8sDp3CyYHUQ/IwyOfb3dGi5gGNkUqSSsytexHTkgnooADS3a78oVdht7Fp8OmsCKogZMIVRhGToBnKWViXiwRcZcWQgJolWeM0fl1cxz4pyYziNKZunzaDPyEM7ynQVAQTytHAG3Z+9WLv08b6QxmLMfx+i3zm2z5CIqllwd+YsQJw9KRxVPvycZ6XIryx1uvjLtWdHCGpSdNfZ+FGYUuKX8CcKYvaCp1VM1SlDvhAXhcSHcRJKJ4RwKs3h7pn1QAcimxjXshyPB2OskH9p/jeS3tLquPHmqt0aQV6mZWa5BpeSJgxO+YmwEJ05eQs=
  - secure: e92HaI8f+yzRAgA5K1fmIRlJtgDku/evC5W8bW6vn1jSBqHq6nItkd+266jT6ORjj6JgHWHpiCy3bw2EUlCsKijSKYqDghWiGzjqH0qmgJ9J0TNAmvqYsvjw/ecV4hmFG7uLs/iFAXgOE15gCpr4ShfjnKeMhr5fW81TG8aXMq4TN/bAUt8Pydbo65lQYadyDgX7A1Jic9mwnUeEenKlE5xCONgP8oW38Gj1Y9U0nS/vuErAU78mtMZsGShMnUqhQ5sHUIDVSEaCat3P30bKYX+9VIgLpmiYwU9ecA/DIC28V1Y2XSEVZLhCcX/9WWl6z6Gjl3rWU0etuzmS9Vp/8UlbZdBAcE5UTVnKaSGYmwgNNz56GLMH/eIG4zX6H3h1Ro4xecD0zoKo4+SsL72u3Xnz2dNgSwnhi50La0vdcwV/Z5ZnkJxBL8+qo8fSGS4LbOsm3cCk5EgUVx9aJgjA615atjzDyebAUo/bGUXpc9N6baCqNpx6FpdVQtsTL3djLFYlTVk/WUbkLImepS2y6IIPWvfx1AFzGRD+vD/TAVAPPv1M2kRfHDZKWny0LUNubzzhxm9jSLK5bF8sY21l6mWX9Alg34QTejoWkioDQhC6CF99jWTjF0cv5OwsM3Ku6VcKiML7jBk1avkOcnD09HuIRkrQxyUyVq7lqj6oqx4=
  - CURRENT_FLOODS_BRANCH_NAME=reset-password
  - S3_BUCKET=ctxfloods-frontend-reset-password
  - FRONTEND_URL=ctxfloods-frontend-reset-password.s3-website-us-east-1.amazonaws.com
