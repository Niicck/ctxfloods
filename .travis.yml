language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn start-express-server & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn start-express-server & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: 0AQve+ebNkNlqLAW/V8p4A1bHX/+O+OVsa0O1x0LhkxznfDY6368VslArFzGEWkTqcsjP3DCuvStlhHdPUhuAWpR+nkPDsaHBYps6H0S4ye3X2/uX2jE3hbkejuSD1ymBbToYxN/VqVMeGe8386vfCeOhK1h0C2GRe9x342SqraJ4CTGeQc0Y40xP6hXb4yXsUARigBo3W1kHOXtTLF9aknFl2E5yIPwJpVP3HP1BUZubbuV9dV1IPCalqINheULlcxu/oV8M0Sr14s14TA5WSD8M+TUlFSSQ69u5RtkZTvf6IRFKdVVr5HLgDx3jehHuu2+XcOgKY9YOQb6EDQA8cUCWwv4NVhff4YP69ao0PJ8RXk8Ul6p57mXRaBx6OPYb4Iu0Xb9vWQbQKunTKVAj4CF092QQ5y+ks59+jrAZRqoVdw1lzEtrma3S8vFpCUuTe9VX6IxcPQqY9KnaoGDY63qN6Pjse3D5OWroHTTIpiU0MZaPvfqFWZMJ7O4FL9ckFDlj1wIIigmYuCNHYVnMfSfHGEOL9fxE4lOicMkVZZqkesxc0hu46yfeNNF5sfWCAONkRT5QdXGeKvN77mt+PHQgi88Zr4l4oEmwc4IP5KiwOuS6srJIxEWHoTNXkLq2ixf1vVJ7IuuIiqb7vxYf6KSV7mXYfskJEFFvBSouN4=
  - secure: cB7nbg5zuf7WNjE8BnXZCtMKmlqcFRpSGBYC/34P3+7J9RMHOgHW0JsYf/38rxhE9KAhK+IOUELNY+GjsckRh/6gdgRW/xQjovLwCeWF4YM+xMYWUhfQVGret6OH4/b/pAp2gdq42bJ6vfjcAn6LgQG20ZfDgwqTyrg7V/oS0/Xp6z/gzbAuVSVUJ2Rv0pSw8ikXDdeP83AWvutDxwIN2enUKkyvC3rV+Qw6NuEpPJTRHSoF/U/LHPYW3+RH2yoRDTygsao5mu88lnaKRJA/T+c4YsPIS2Efi73J85FetGO0SdtlaphjzXGkmeFgSPIy5QuyMxjKoOj+6L+UWjhD1nkipyJe1bzAz5ex9SjDRv6OJtVmRp+/cTtQeizdWfKjd7AcCpaNaU8KLqN/zRIhqdx2xkXrqlsuz1E0VwXzdaurjDD3+RMJyGLwHuwO3Wt0m/FGJs877Zp9s2AbPzDAc0hFcfvrI6wxjXvPPFpslwfwDRjr9tw/abS8C+h2CTAWkcU9CN7ZkLj6zEJxW0qUEaX8JADcEKnuw8lnY9RImO8PREPP9tQ0T3ys8KvFb/wIBXGwwfiH9DKx/rA8vDIp3CiT1lyebG6amCuBcsuGamBuzewkvDeRyLzK6UjnovM58mRcYRRPhMBX1PyFn8gVAYm25QECtJRJY+qvNwkn8DQ=
  - secure: WqZiP+42Ixp36A0xe4AhW4hLnnOznsp3gFUpKL0nB2zO7J7xT1VLDKHvPcVf49AdcZ4rPt8Xn/GbRxv17NHmw6DZjWbvL+q/LpuceYvetHiZtycOCXbeu1zT5uB8icrnQl8KjbTdII1+roJYxirb6eYTeCk/zl6bicjVBR3iSGydOA6LPylx9FY8BEr8Hb0gtjsZR1jwkczVr2M6zYG8SQvbnHWNzgQBYJzlD7Oc1zvejYnBAbnUZQUdFe7Ma84TCS6gVn0mIh4Wi9GlggiKek0TwcYCTDdeJrcVaW+irX9CFcfrQCubfIQtc5D8LC1C5XT7SHol21M6G2zGJ+koYJcN40d+5KWUnC5GbKTr8paV714fG4PdvKmVmcvN7NwDoe3Fjg+wDMhdC/2ZH24aaeoPFrrewatq/ijxbkPq5ErVLwIxdRXu21Wy/PMD9NiyYRiQdXtOq4Z9tDjiWoM1GPhZzK/VW+uv36lnOzDgwxdNpb5wnJnTr/EObXaajXmNJAy8GoKHIkBed639AcorOv1DdV6adk581d7FaulBbpK/ENC1wjGl9WPpNtsbx/00fmA041RfWFTm/BfKun2Fw92SF7JJczI48Urkmn0NOVkjoMGM5sz24N7Arrld/dNB2CxBT1MrmUk0exXy6O1B8DEw5oxaWt41d879MXAYMnc=
  - secure: gRJxQqz5ew/nemlW6Ta3SoMEWwNvRs4qTFD0gQfr1o28BTqeFqy7I0uXwSR6tFkpP1Ms+VPEF2KaMwx9ddzr0dF6iMiL4BmvUz97UFjTwL5Qr5jYvOXpMv7n6Ak1Qx/5f2v+pEJUDUX8FzK5GgoEC9J2KOK6vw1Db0493xY1WqtPZcVjhSlPV1CGU/4zLIPR6FnTVkiUExC3AOCcK9jCZN057perUobKtHgTmZCrsxfuqbBAeHqDu6uyHmOVUmsOYuR5adc0yfE+yIcNSm31LLDatarRShil9mtAfbwE3c52pZFkV1VlzD1ZM25YmpEvs56i83SQIaHbFqPs7RtimW6ocUdg48zNC44nZ4gjwAFKttvxqDXgXy3ulN8qHPc/RuCy0qlcWyQiQW9LXP4Yurq+ANjl/5Lo4IjN9LSB2TCnFH3vB/m+PtP2SoW8vqLOqdUcMQViKIMHLP76h/iP37A9NYgsxFaSMvXaIXlQ7UghsDdgomXAssYRWU/vNFzAB0oRcHooMVc4fAt7QW2K8PvzyE8NXFPkRyxvWtfDJfXmauPk0/dz4g4pZyxDwKr77qpv1y8QWqUNweyBfW06SIRhJcYzTZZSLk0unZQgycFEOAFcL3rrX7TFwAC/8/OmOQJgRBwIxCRfAzJoRketDXLB9BcluMYMSIzk8A6aSzY=
  - secure: Rf+A3IUtxiObpZD9BxpXGH3Xm0VLTDhfREXIvJLsugUFlBYjYEVPutER46IZhgxsT/x00aL3S+at4ngJsmYhCgjWuAOIA1/HEmBzz5bnFRt5v5Fq7my0TolEHy0ZpdfwQCAGpLuWJSL81H2xc6CC6bIUWr9/IunNgaainnHRyNvUErkGYyjIsQgq1OKtrwU7YUGJfNyKnmDrm8cvBjHptW2XIUGqF0E26mhfcBNcaTzdZCAp3mDYARnDs6cGDkqlqT08KbpevBw4MOHlrNnmc2mypA2SKtp8G9qLGuuCg271/OOYqf80tvHzXiWxUruoThHrQ1bRlt5R39F6YQ/o7rI3zEEBUxYh1M30SBPiyLNBkogx0Ab/aWxECMiEVtQmhVsn8ZRzjSqO/c4/wKRX5fWe8JngtM6nidZu/Quz2s8ioY5pszB/POGYaDtJvl+qjS7n1Hwc+L/V9QxHF19hz1HjNQRUFKn5pRuhV1bdkqnxPKzjPKHLbwpynQcgVDBTpnbWzPa5+nztrIYtMoPTAxPsTWjRBQzUrcIEL03ZtTceE7iJCEW7qTpdmXKwuGxgUVh5fcoZCz5xl75hJ6FXQyfg/M4qnLoRravmwK1tnUklQHLd0PsS69dHj5FwM52Clv6FRBgMWiwWFJFrGIPs60r/qS21u565yD2nLws/Pr8=
  - secure: R+D2eR7VTO/XPmJQCS4HCQEtGFxTaNIYJ6mS5ZV07lP690IuqcMV7R7zYqVCEOX1SJOH9MrKkSCwxMLoNlf8H0aAAXbgVNG5mORp7lFMwQ/2YDNO3E9/7HBVSNWbm154ECW8hi1IDnZdc+saHHpQD96Uspuu1fefwPb4jkkRy0jfEiuA7Q4y90EdnkVG8Z7+jA1Vs5eHvG3APGfmbEMNC/CBStMyMNrijI90apngClX9KcFlaBSsls3xXl4H9cKVUWRfko52lLEocmXnf4oPa1qn+evbJbHNQ+vr11B2CRN15xqDTsP/0WlW9F8ohB0ZN+fj0NIkLX1cubCr3G9fi/J3gYu7/juNf2PTT/Fusks5Fu3KtxRyvYlsLs+AcLhJLd6QNSrOshtkl+TPfWGSLuNu49cnXyAe4xlnqE06EaiL9Ug3+li2unGYzCYKieymsKBEjNXyC7a5zneeznKF061/gS/pSFCpR+Slja44SDil0w/ez52nXoEGEetIUQ0ceKfTVnyjNSWQUcF2c7A89Fg7WY8fxW53vToLbdT7euBoPh2BDnGdcuBzqriAuBVVqJrPdmvftYdrPF+N8INtJX3IzFCiPGp002ijrM+LOmXC/ESd5bz84JM/ixOBiX9s8lZHb2b0iCYfZkHLcsLiy97LDhUbK1MmRXNSkr8Xr/4=
  - secure: RjO9/V+ecElZGLFrQ4AN/LmzeHzv1Zr0dQ2/nqN3g8wG65UUQsEhvXC90JRA6NFM1qhYwneM0+h6a83pQg4PDaod83nIImIV6nQ2AO8JHIIXdDt2XCZLqFJ2dQUoL9mZxMUgicQvWqzvOK1SNseq6hoykqdaSJtEPu22eSYhzj3L7tkvb58oQrswvZbzTgRbojf6V5TCxebZQrkDQrV9ARilhmHQjOqP8WL7MEKOa889gcIm17xqLyX/e9yvmWcnayJBamSBm8yV0UZproe3olZfs4QOEZ8mUhDdh3PSNKXs66dIIrKcFTb8dETvurJuZbvQcAJ6a1UVUNcD3rnS3lQGYlfYAkhsGYJf998qlQwlq6Fpl2a00546gzEVdtqzIuF74LaqCe6ePUfarxOowKJsHfQb5r5mu98qhYNK+xQUJPP+fJ11hRplQedlUAuNOEWqNvB1cjYXxD9PcONiyXbD+Ri94tHK40vWXupasod1R+oyVAtljXPn0fUiNxANkoTGhCTFxTGWR+0mgFqxo38UFAKHfwG7xOsxNcQd173uGBF9GD5Be5WpSrQYD7hQ6yvEt1LYdTHXAqZ8O0EVkyghVpyuDRc8DqSj8DheJ2J35NVSEk71TMb7HLmHFyvvPn/A7lwZmAKU5uBE8Sj8M9vmxGYuiYtgPtirGzXNroA=
  - secure: Qqosx/s/VB1kc8ryd4QwJYkuG4Qcr9ilhE0IdOaqthDOHDSV3n0v1Xqim/H00Q8+NMUYSKDUXY5VrwFp9j4jpmBZvG6PLHvRxu2p4mraD00Fg29jc/mLC97GAPGQw1hWRHxxqUbxOKY/ybesXMuIql06AK5d5ouc5zoAuWyDxGVdX/tS/WVkanzeIoXKhuPulZSpikfVvIUINGUUpk9xihXdjPz4zYdneLMgHjO0987ARmFGkrfrxalkBPuyKhh6kz/CHB+PXCHF7vT4rjjDMG2nud9S0yzXSTL5sg1X7HTenzKG1B3IN0UpFMYP8M3fGgi88WL9lCvfh+ke84/4jUyi+P/iZ6eHEDG1iMEthLk2z5U1M6Cy0hNGl2JzDqc5zzurByxQ9Gqmu6j4nVBjI1G5Ee9Y+dYbde3eWep44/tk+3wOVWHBnhZUUTbnyvqKayAMjn1Rf9I+D+nlOh/yObMsdb9jWsqeo8Ex51JlckJNRhVUqKZlHg/mSy2PfQkayuvtvNwD/sAmI3qLpdE4cjLYrUdlHDewHZGSSRX5PRDk9i1ievYBVsUwB3RK/BRbLIWQgJCMdjt0RktiVaUYMCPWLVI9DsoeL7NGS71jKoU0aTLo9+0YpE99Xtz59VNpojLRAlYeIIqokuvtTIopHB9tDuGuGuc518LA9zRboOM=
  - CURRENT_FLOODS_BRANCH_NAME=reset-password
  - S3_BUCKET=ctxfloods-frontend-reset-password
  - FRONTEND_URL=ctxfloods-frontend-reset-password.s3-website-us-east-1.amazonaws.com
