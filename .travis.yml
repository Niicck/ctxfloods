language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: PQ8tQ1/J0unxt4/HlMtnw/hihQkN97rKyRpPL9vZaqeSz7gxiOGUixzchVVQ5YQzb+F2Un5VQvyCMwrVj+Kram612l5vpxp4NKMqDOQPDo50v+vEgJ6ITPc3QvkIgDWQUk8PcVOSWYupUmPzWVDr/ZOT5gjBlNWXnWaksQjC3c6FqnQ1Qus8cwWc2U/LH10l3r336Wq1+Lv743ukx34VKDTY3Ump5Z9fIgjYIEDvVptE73ZnpnXCP19+k7/VgwTxpXxh1DMz7cx9MiICZzfagjfa5NLFM1zLFgTrnMwtIQ6n++2BKGvrSLEo+Za7SR9qAoy80Wm/b6xN+QnZE6hMe75nXDvrrrnlczsBFs0Q3G8grUlImnRqetdh8AbnwqLO9etbEisUke3rrdBYhOmK2mo3IxdmLVvTD+PPPdTXStsNe6ONp4MMcGku9hEzNBXs5c5hDp9A1Z6lyVEJ4Nmx6Y7GY0pzozylRuRoC7gIrmKtoQnZd0fKWphhtMEMD5s/s7/Ss7v0lU2zdQ90A6a1QUECQ+hUthUPAOnVKVc/8wT1hiOLRE8S5Hy14Lekbof6HmhDJ1xcHwkgvLzCpiJSkZxPvGPTMoTB9E+8uCp+wb3nryfwiufFQSr7rrNpcocYpUF6QJ3sipuhMcq87wFUO1VjF3hPjNWb51LQlcyksI0=
  - secure: cBAldUB2YOx9wgUVrTemGmMPIifcxeQFJDKn51z3sl7P9OuPrrh4LQPHioDuNHpnGfY3leSy2WVnzIAuDHJz3jAS9/80RlaeAIBbDVNPE3CZy/uTHQy3SAmDSrhI5NPgzFodtAg8H6MU+czeioEeUKNuzfQ7GSuwRK+sev+gX/wjotLhgYR4Cubds+zaRixdy0AnEYfca1IVDcnqYBLcNBRZazgVEVZo4DclhsYuv7Z2vBvrIB9doyiVnNjn1b5XB/qMhOObIE31IgWITnMW0zQg653uH9gi9q1UBCtrmYn54fYUB/0x5nbYG5BzWTFjN0TZ9uDRJCCnRQfdMCVt2xO+dfNyk2tSlihtpDNhc79XnNFyBCDFfnm+yJLkCandF0T4nTHixtzJrMEZmT3JxmHXW7H3V/mEp244aNjog4pdioeKwyW0eROusw6bLVNzw0eFg1ztn92/a2Gy/ZKRkn1EoJ/17mn+BVo06jIUI/QW+vc0aWZ8Pufzuat3MdWTgAn8k0/iBlbFOG2A2+KUcm1Hz5DEfVDENUeAvfYrZkC4dsCYaSvpbwJShHlAaM8Zo2/ngKTrRzeMbavmyu9ymLp6ktLtbXPAEEd9xEV62VmnjRQ51o/PBRYCwsALFKzvQeJyEhmxLcTqZXwLsV/6qn/Np695yQVvIliTmkoKQl4=
  - secure: uA/nUCVj32v4QMLkTF51EGRK8qPLff8i3KOOJfryLRC2Pt3pkX41mybVmKLhxe0zQS36wRx4/KJkCNSeRVKQlcK+Li6bYMOpyvHKRxNH3aP1uC+oPXcr71Z1qR7JJxHUJWYAhVEu3C9nhv8+0zmsLxwm8mTrHM4glWl1GwjU7dlMhkxDJ1ltnHytihFvEs3ieL8PfyfZiEw2qd1s9S0sycDPyDer0h+JXUVJB5jE1d0D3Vaefsu39f+nJEOuSd7+JFPgh7TcTH2GkMUfa4dA9c7+7WS9ytrwl/ZfxHy30z0v8p1ZJ5383FMHMkUKXxywzfTZXPQ28OGPBYVB8TQ+H4AhGzkSJYfB7VZVOGkLXVuXNCuSYivl7fFpvlBvPxmJ0q0dcPeeZOMCw61t51bkt0yTCKWn8/5VnBdYBB34NzpeVNHzrt8Fl1YeMSeIiG0LKC4HqNY95WWRFkdTGwOPTzFFoRsRXFiqVAPGPcfhamJ9wuAhe+jZYLLxhe3yEuEwFDtvlvi8NuryzSyPQ/jYvfcoM07d3ds6edQOnqF4CADdSVwe4/nETVkExCfN7dqqsuIpz4CnRPLtyVVmTRGKpz0UnRRK6SGIHtuBv5EUTu9/cWdzDcQbxBojGRg44j8Z1FXcSFEey22TZoHduntmfaS5YVBr4ERnzR/66yUfots=
  - secure: ua9dBAUIyfkffGWpftNdB99v1RhV5dhZq9nAgKVjxawPiSJJaz/QUbGRuIJVKFmz34iSBP4zsjcSqP/r6JnbKJsUlFxxrKwXuo3Fgpf5jY/a/bLAU0NVBDm47Wfc7nof2qaMP+3uR8BvnweoSDavR62hziZTuCN4aoNu3gGvhasCla52mwNM6SS5ZaQzs2j4/Kaw9qzY9V1LjzFifyWaLIebhiuEAfe6ZA//qavBWPacYEQSSpHXJU49JpnKG61kYYf/OUYqDfAY76XNunpRXLe58/GMo4roP2dLLAcrc3gJF7mJ/xq9Cf8ZjLy/1pgJu77XSyyktzWnV3p8Xi0/Xxum7xYQMRtOYL8onITzpdGQG3tmkM4W/6TTuteSb4XMOPr5r9voNTdwVmRbxKC7h7yr7ormYj6plfWEvK2npmYOqSdHoaWX6rrJmz/zmaHCCwWdP+TaZnIwqjlsVrs4q36yn0nEX2CHjGZl55U8EIQk0Yd9OUdsgitbnhonarxZE0frtdXxRSB4t+Ov0U6GEAxp8mth1w1zMEFfmT3F7QG+4rqtsTZWOx8TrjrWLx86OfjC4gazRitAujDtHq4QVa8Wcd3kWBkhReydTZ6i0j/GSAsWCw1A6K2D5unlauCMTnid/lkbhAPczlI/jg+lNKIVOKPpmXZNLpLE9v0zG+U=
  - secure: AvH4CYj/JfT2h/xNvtHgSaiEo74BQ/x3lMguDMwmP3kWnbF6ZSz5txzyCUSTfMiepIfjGca1eRRT4GWIrHrLKc2YNxN1n6BcUew+cCy8zrP4oLR3+dBU2N9W/T47v2lJUiE/sPtulDVdA7VJZXr5cWc2WGsIxD8YiE2B+xGqrRp4NpX1jyvis/QLUpwl7alNWgXFQwo+lL4XzifgGpdDwo+6oAaRv+DHsO0dyByJt5aSZKqOwGKaGz1+ctpeJ0R1Lf5yCWT6gN16tgDUpgXKDgmL1hICnSYna+UinHi2KwAFhgF5Y77pUZdyRSMyG/7OI3uTNSd1sIhbn8EQR43vLOE/Q6EhxM6d9GGBVQnNfXgUNbKbMv7dpqn8BUUgn2ETfRCHIr2rBHYbYXc2aogDzg8IqMNQYAYGQvZ95A8u3cIFOBWuD8QYKgJ0b0M/Y2JaW/0ExPd4CSXGrF7rp/ROkcoPoF+3eJhtXQaeGly9PwyL1mxZZYXL6qtdVYFYK/H/wS1lVYoMnASf9OXOF0Nm67eSrGIdkcKNDQrpWU/bb78zv/QRN5Re1joz0rvDn9AWjXA3/q99mZ+jjfawRWtgVzAzfk0m+FC7zMbhZFD/0NOprFlJz4/aQaXicKNgq+ksTsuao7rXajWkJ2TZlos9NIvflHd9pRgo6nPp321+eEw=
  - secure: hxm/p96oiklW9PzaoIwWZpw4rj5fMg6LB7ij50NonPirtlkPLTCJ8c8g9Z+mBcuH7qpqX8zqEZJVTgMEmmhaFjrAilxsjdWjoycVilbJb7L0EbDtOLNio6rvX9SjL35z30TKGYEK8Bn5oo439pkfKT/RKcUaBFaWmVlEbImrDy057FC0cwSwhJSUJqt/0Nnvb5lVBQQ/dneKmXl32kkckKYrfBpNZeBCYXhc5HEbqZ0/dELrgtabPdnRpRBMxAr0y6mjPhU/Dfd3os2QY7ObRSWL4f8eraqulbDSNG2M7mJTZMro1KW3u8OrYC6E2ut9rrgi+IA8HRoLHZcMNXiedazGEyheQ9GzVX0ewjyeM6r5A1dBLZdR78ZeH823dxsz4Ed0uPK9sKUHrnWbXDXwZfhB1ghDDOdq+PSTMz+bI2oCSwQbmGfnVihElqq/36iq9eX0NUylLQUqkxbxAvaFPAin56KvqY4KPhNw/GP3yhePc0hRl1XYi/zEdsGQEFvz3xvm4G9o1nMGP+dYVtpk9oHCHRCGVQiPdF2QzqMYTPzejUW1m4cnmThwrNUV0aAIa3mGe/D6cS9DAZN+iN69Nj+zuWQ6vekHjhwvZLSkHQ0rINMu+Y7jA1umSeke/ZpUXCzT6yVVpZGk6eEjqV/axF4DMb35k/nXjvVTU2NN0pk=
  - secure: bO6xTDWelJlQq1P/x0Of6OnUEm4Ch4aruf8TOsaDuw1XUoS/5t8eN9oL7/yJzCWwOMm67ixANOniDd+D3kHdR9cjrdeL1rtQ7gCbTuYvPtzpAa+15kgaWgfpOp8G6rHTnEBL1yG4TG691IqSCv1U97rIE5EDqjjRwkpH9u5ac/Z5ZnZ+7XC6ILYkYlUQSgRcVBd46jb84PYppFAimvLdfzNT2zI1BiDCi5T/+fn8m2hTWMCDLBP55jqspw5jOXiSuuR0Q5wfzU43qDppMiiqtypjfGk6iQUJrI2qqO4hF9OI/A50ShfMR7iYvPO4z5PxI1DyGOpqrpAwQmPJBWXl/T+s4rHTqIxN1Xb6l1/QmMIGn+PC24hYIya/vIcG4tY4bV/Dw5iG05WOA27UvdHp/jDuRmAoJPBzalfCMVzxTsSq6f45nU81D2dy82cP+5hdm9R7nPGe09fGdLnNSZvpAJMnF+A4rRdkqbcdyfp4fOKEqGaBj007EdF5BdjvBfLPsFZvAWQDRQc4GlotZ/AyiOSoaHSifIggeyNy7bss5hR7dYQVsFJaaP3rA8CcTKNfm015k6N14Ltqsg2k/62/kIJv2ZCH9WxfuDnpubF9VIm2ABSh6HMeHus63n4ZfBumdv+vIFa1KDzs8OZiVP5nn4vQ+/SdufnaHtPuzHCrJRk=
  - secure: CaeAnYwKMOnoKaY/Ebk+LKzJNAGf9LpzvWZ7LnW9vaQScYX474GY6gU92UZnf4fjOC+0zdIqwn0tH6kkVE+LYT8ULI5jRZmmWHm/Q+m1vr5DIpz9rE/5LwHzoqluWQOTAF9NkWOU8j9kEBeD98/Gx20zGHa3qSQFPAp7cbVRBZJ2SucIrJQVmwOfdoC6xZqK/pKedYaGYaC6G9SLlPBrLumkrM/Yte3KoQFiETUvi9cE800P1u9rPL+Q+VaL3zA00d+wIE/IDwuvO7Ev/L3kscRTzPo5le0TaC4yzze/h3zAIL1VUAL05aZ0/y3bwd0Av5O64aZlcHJFYlMkSto0M/MGSrOMxmHN/Y1CpKvyvN66D4FVoM/JaXxCzRKyEORmlZ68kvGx2Ea3kNU/dk1oxeqvS39LswxCAdQy2ZTL7RIjT6747DJzcYfQ8vWm8uk/vD1ijL6ibTtToWxrveajIGc2uEyDR/vxMUMtgLtv7fAJs7AV2xHjoNKdkQOsSFJUeDN62JpRJYeQ4ML2omWbrO9jn+b3X6xpYg3MN5QzpghmgATUgmHKom6vrCzvKsf66Hr1hwKlp3Fzj9ftKKLy2xOFdHZH076ukoweIusOiNSJUnXlcrp7b4l6BPF5HJUjIqzKghqaL7m8qMhgXhqtSj1j7fTfui/H35ftljqrD/Q=
  - secure: Uj7QMrTMHjxPdgc96shiSkdiwkSYcdrlDTkCGyk/CfaZfWvYhLySl/ktPLUhB57WDaYygIfKo3zvaOye+zW8Ht0REYPQmpgBRcdE65yWMpPYSyE40f0D8kqgn98slxGv/m8pZS9F2R0n2pU7oW3WjoY3VxY/FTfJOX1SjetSgD+ideg/Ky8ntxo0zYBivWGbBgK6eioOquvXCCj/saGgHyP2RjfvI+eLepQhIIgQStMZcEBRJ0e6iyoQppzTRlppx4fSIsH4visAkBMYx2efkyq3B82BsBcjgFuB0YRVpxUUSJ/9uOZbfZb7y3FJhScxVy4gWSfT4fsnVF66Hm/RD0FgcEDc3anN+iTUNRBww+2odpW3qX+vYvSB1BaLcS5A2nYq0IgV9P/0WK5WrJhfrP+vZmpEmCyLfTBLwL2zIasT41FvxG+Ltv9MZyK9IMdyYjWVPQCPkIlyEI0dmT/yHUOoKxrd18l8ZGrdAwSHolQF7VWFJT+zfDiMHh4NJgicdBcWDjyLt0vOOty1u4dA4EJBp3LVK1Vzg1sEQfbMkU9Vysh3xTUTv/EMxbZta4Ume1S5+TiYhfQ3iu3wC2pqZFyZfzCI8UkMEx12uLtqH1/i3RztxLUbFr9zNgBi5Bt1/EgJEwmQBap525IWA+/Tz7b6pD8T+zrdaFZyv+L1Tp8=
  - CURRENT_FLOODS_BRANCH_NAME=reset-password
  - S3_BUCKET=ctxfloods-frontend-reset-password
