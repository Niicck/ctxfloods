language: node_js
node_js:
- 8
addons:
  postgresql: 9.5
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
services:
- postgresql
jobs:
  include:
  - stage: Test Backend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & yarn test
  - stage: Test Frontend Locally
    before_script: cd backend; yarn; yarn init-local-db; yarn local-drop-rebuild;
    script: cd backend; yarn postgraphql-local & cd ../frontend; yarn; yarn get-schema;
      yarn test
  - stage: Deploy Backend to AWS
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn rebuild-and-deploy
  - stage: Test backend against AWS endpoint
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      tests."; travis_terminate 0; else npm install -g serverless@1.25.0; fi
    script: cd backend; yarn; yarn test-on-aws
    after_script: cd backend; yarn; yarn rebuild-and-deploy-with-tons-of-crossings
  - stage: Deploy frontend to s3
    before_script:
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "AWS Credentials not set. Skipping
      deployment."; travis_terminate 0; fi
    script: cd frontend; yarn; yarn build
    deploy:
      provider: s3
      access_key_id: "$AWS_ACCESS_KEY_ID"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY"
      bucket: "$S3_BUCKET"
      skip_cleanup: true
      local_dir: build
      acl: public_read
      on:
        all_branches: true
env:
  global:
  - secure: m88I6aph9EcA8VkZWO4A+4To/rXaPMfL0Iptgz5lRQ3fB+Pf/UQCtHgqM4N+zIbqJ+3v5kOHloP86WlqrT7lg7WuycmECJOaD/YRaA40BZqHT2p7w/oG6mltC8okgDWmuCxvYP1doOBQ9quP//JA/CApXlhOH58Jqze6+tIdFiWVHh63rowLNbd73LGfUnYmAP+jBT0l53VGzdoNBMTegBmbMaSJv8LBfk5y6wN8Sn0T0YcRtbzRthRTRUnUtSEWmO1PXryLBl2jCMZiJM+0d1wLsbZUuPHQthFdb/N3F9XhHFQzxgPfK3vZmDAoiGO4+tchKMPmAdD8JtrZ9bJE+cg/xDUhmUh+yKR60azLnj43tyPwknjWlLM3a9wuvgY2HRPuSjCBFNxL1+kQXaxrAbk4nymnBjgID44ViiJT1/DBaPVmQfXIpHAO4X5t3rpN0GrRYQfwQVzEB1GpS6l5i5J3yvouT2v42lcnZW4oov8IBXg3IKOENY6XMM5tqF0xRDDZ19H+WQ6smPITGmiKU6nlXzORsqxzJd7mkhua8206LPFIC4kKU57SuGUZAdqLhxp2FswSt02di7OXfjkfScH13o+OoDk4EtsoFDee5YTEIcIFwTdWqvDQswkuex6Y3gpwVMtj5vMeG/mB9q/n7h2AL38OzYUB6JRyQJc8iUI=
  - secure: clBTjJK8eAzdXFJRTteciDBYT3beaKgnpyn1fxKpZFpUCv/DjbT6vw7hVKTW0nykfnbQMyK6pDaRj09/u97JkDlx1p9eEBe+qoQgl4/3uxc0D5Eb01Ab7atiyEJUaGpVucYCpIjpDcWN0VMa1S17gp6TV/CGb4XJivCdJqZMkAssas4Ct4nO+aPZjUEga/g0T2KwE0h0doVhx3beLaTaU17CmBP1AWhLy4hBF6VE4hFDpWxXyPUZl2/i0/mdKKNArmZ9OqiGw0L/fChIjtTAWpXncRt9f9WATJH0grojmPgPEAUGgm1odp0ZXPJHtLlXSGulK9RtSbA3FEipgcWhnYcIzxH2lP7W2wh1Tx9T4Rq4zuqr6gM+hZYfr5LxhMfg+X0qEu/enNzRMCMbGRs8xv5zyahSZHEKGw7F6nFzxLePjl91PUolC33gKX1FeBimPk4AlkXv9vqK8zTdTNYQpgy1Jc3dO+JVAcfcAg3GnMSQYJ6DMyPK8BLi+lWKeZiqwYTBbTt1SFD/zmmEAHp/9Gtg7wIvd6VJsJdKvlcrndx6BI+1S09KdtiF1sirDUE/IzIsaN6g0p8AO5GO/HzNhXY2D/j2+fSrD7JQ6P2uhw8gD/yQUtADjfRS/cs4boEbiOYyN/JprUlLFM8XX8S5ytpLioQJ2rZynO5stL29exM=
  - secure: wFrejDjk4hG34FKPs+WfXR+5JMkwvQlzCoaC0zZlYJ6MppB3FI6n0/oLXXSYC0V1Z61tQJ5Km0gVIbCShOY6VISwbQB8qjQtkJLrr0UFoKcV9eTEci17orWpSCddzr0e6soAI7jgoOkdh7FgeotXrEmptBkfWd30S5WBmVYJGQ4ig00blsauEv+D4e6scY3CFpbwdDUVRiuCalJNFZd9zVoSt5MtpsfbXGz1gjSWHp0CE7Mt65BdXxCQYpL/Q5jMSEmNIWXCOFq7S/03p7Go5e2akHwpAmggFnboB5m/ISZgCgPVasfCvEywI8JFaMY8w3CpfcPbovXK2mcpeBk5cIMORHPNaD46Z8xjcsW9njLQM/UfSg/dvLI7Y48XK5NnrD7p746+wNz0SdLSendFtsQDp7EmacubQtIJENdE0ETfEXWyPuhaR4vlogwQUiv21DNJwOxlbAgtfT7Qt7U6gEHU2hEGpDKZPBdMncDucSBaBAycel0TgqamSEsM+sPcgwTFcEOrZO6qNzSMa+gB7cDqh1r6gNv+zH0xivIED78QhFY03d/xHfKHjfZ/X/3YZgLV6qVABycAkaaKzhkB4NrKJGqoVf+eUyPxb0IPHJlxLmun7p2VboAbYBwMQ/dMo/C1wQHm6MlBdWexXE4mXpC/IRVh+5Zs8KWolgYHfPA=
  - secure: UYUf8N4Tok5GegzPGZch+xnpXKHkPuiMl+NU6qU6l6O+eMIGyGlQQdAZsQbT/ilAbwObxjWh0V0wcw1FiRt8NBiuSSaz5aoagp76S/9M6CCLlJGlTS7ptldBeP/7Vq8pB/FRGqx6pkvSL4gspkrMyCeTi7cO4bGYhxPJ1bcEmYLnpqLWhMZnq4aIsElQvJptXKJujQesVKS1lxotYniQjtgsyDtp6emog4u+q4fQs89InDWGviV/hhsv+dzgQw1fb0sqbRpHS54W2aG0C2BQ2v6reOcu6RyddkYnn9IuD5XWWRS2JcfudEY707sXwSEk+O6h7ONMLSLEWykJtMDaNP+c3M0el6Z88OoBM8HYzo8w5JbuTr/lsLopv9cWYyi7kxlRatLhmBUZ56K09imC8XwpNxPhC/4D95zyZkTu6YyKJwwzJtoFfwYd4eeFj0MDAt5LRSMMuFnDxsJanjME6IJdydWKhWBnJfmxrqkyeeIY1nL3Q9U2NcUllZKm4aKafffKCKWStUSdf99ZCZrrWyQqyYHEoZQjcPqgA1xFjNX7mdJOKhXu8802ySYGnFTuocA3p5x8WcaESYN5Bvp8DwdiDtvCXIWSE+v3+QJl0UVJ3MJj1bakfiZ1UbZgDOFKRcl05day5Kwb9vxzjUKiL6+7pIEr2kW0dFk2oKMleFA=
  - secure: NqZ3RpL38ryVY3RcygsvZi8EOemeiUSINDNeR8Pnj815v6fjgPLukCzO7H5Tl8CBQK1eq7pcL4b2lc9XNjOw1N3PkWxZ/6pfxXGJIkXwQI4BhyilpsOzueiLcACZNOZtLdnYcfRELhza/BQJ067vs8UNMHLTDw8uTtrsThhljo8vBJxyL/J16nrdkZ9OBbYnvbS4u0zJnVx7kwQjNpY0q2QgDb1vmYhXwOqxlT3jl1wW79GkWNWxF9EMwZoIfDFBQbqNI3fvhqu/UEkNT8nZ67oc6RcVRpndYH+X9Fx+nh1s6tRimO6mHj5UgSum631QCBguqsEyYC5ruYpFrnNoznxxE5VvZ77erx4Wp/A82kOSA11aiVWfbAfc8ihJXVwaArsQOmRE1WHdIvJD1FBlfO79FAHfBFDhVRAvApR2URe93SrUlaJcvS8jP6AGvdJgqN2ic8SQF31z3beIIfynWjVXx6aNomp3677twFn9jWv1QXqMFDvwL6sHfnHreXkBd7JC8IJFfi8p9UOkTUptjfanXHJHl3v8zoZckVLXfhN1l8qVCXMvB2LH+n6nCYexYmZPLEEuJ7KIxHPfeEbGNlLy77CfcwTqYE44R7J6cUCXX/WOZjMeoNqLq7cYhB4RY4ZfVAx2Fu8tSufMtwQD8FjIXOOxSNBWOO30hFzPFhM=
  - secure: P5o2Tj5JqwkCAlGaeC9+stcJL1nvxr/okeNw0Lh4OQsOW7fwuh5Xtmq1Yb34bOhZvbz0u6iJF8mUdKVIu7DPEQsV++w4VxZarPqJrTEncPV7ASEknaI19kTEpPu5xke+uLAhA3eD+FpwYuqL/8UFWCu4lAiDm5cN9xP28JvUUzqXIBRPx+6lDqk4QBy5tKmLuhDRiExhRpVxoF+sCvIz6mxY/fF+HNAQ9+U+LRzxBAFtJKqKNzdTtvelLcJPe0nOHRslI32EIgTiOBdr+nwQSn7U3+XN/to1yIf64Q2XqZw2g5Qpnq1J8FbtvezYtpdALP4pblIwYIn0ucN+DR5wk6HCcQMhVKkUyoqZ/JJKGQWjlghYsdrfYEagHcTCHTQiy2nzIxWz7EMokYHxGFffPBwOy5m0f00Jh7aKhuSjTyb+0/iEo9hSH6vFFplmlfQ0Qgtnlus8cW5mp8ZJIEY773TAg8G0SmtfXTpA/mLeua1eCpFvVrxOIEIo+x5Pk7yZKR3fWEIgzF6S0Gpf1rInhCt0H7hgYqNrlKLepARcI8kuLyTVd2887UA5dopOA8pR2/Crh6p29jOGgkp9oOzeOByPKyioj4XZc5egH7dt8oRalhblTWc4C92/6pTSpJttc6ZtUTWPG7vlJGncxBpqf8j+LM2MpvTa2bCNfJVySZY=
  - secure: yH8jpupx67RTXftlbekvl884EAm/dya+5TG+5HrPBJiA64fPtZTRYSts+/wrsfwi1hQYnttn/BuPMk9B2SK3G38NzpHI2yx9iCNJWo0ovJz9FHwm2n0N33ZSFZcQGIlQcCaGE4zg1mPyUzwX2Fkq7jFwt/ie5OibDFMAFvQX0Mwx54o2GEnFxZCFjjDmGJ3NiwbiXv+JgNpzYprn4L95zNknwf/jBAlGiYHpT+DZnrdhK0L8h0Gsc4Hsh0A6t8OZ9Ap1JCrTER6judzVPHHXpuzSdxYZXDL3zysipzA+4Dr7Se1olBF6oV6W75O1xefZImK8hnyXnm+3QkjboMR7SPlfKf4WiTA6FmnQGtMfe7ZKJPXMEq7Ti50/9MjoTDHVLDXN90miwGL7NPg4VobTIUiztnvjAqUFj1OWYx6vMLiy1skz+zaNBb0vPhhq4NN/RDz32lRyTJkxdyOy5M0zXd0EOx4uZYaFOS6Mp3l7zPz20/GEstajA+RoxXrHL177Tb9Vr/edVLXZQivel4DjbbOeUIxKA6Lrc3srKXVZH/wCDZifG4sVD9KStgKeHYtcrSX8r66VRi2HnPnwqznqs3tu3m+mpBlKRgg0DruW5UGxa3Pd88YrpJmqY4Q53Qdv8VlsieFVdAeKInO5uIiR+U5NkemnBaQx7iVwPu8YPtQ=
  - secure: pjh7L7IqMtxUrB9q5QMHiKEAgD13oLM3PAcGVbD171v9oQQWR6tkzGQgUZX4wF5nLcqDrTjQIY7rsbhMaVq2kIRXc505AqUjaEP4e1/Nqi0WFaxdkXSUrQ7AhQOfD4Sca6/4djh0jYafDiE6nR+1hJV9m+ky5wGK3sPhbamA99PIXqJtBG/WXaF7TvhAdBJLdyHpsFWyN6i4ZuO4WziYVQLw2RkHUhLiqKdMGE2OkUiYRoglehmv23gZTC4H/zJaDZKrGKe5pO7e+yIBO0smEGu5L6yMu7ZGq0coAl/l64/qfmzMHiNwtw+CvhM6RD/bBEvKndg69GYNxvUNYRve0QT1EE9X3Z/Y+kQ5QfELhdTFv7Q80QOtwdjiZ4AyxkLYup3CGgE4eW/BrpeO7oQAqwFKVYwIhWCHWPPwxR5S81JTiGZmgFlhr6Wr5BWZnjJXZER6qJWZ/Hhp1wmYFNyZoBMMbfknyAMqDsNfJqyHlW9Z98hq4wSkm6VCHDfPsv7fFSmTsg9dAKW5IPvGrqdGPUrKAXKxow5cCv/W+m3KdytX2KUX9HlMiKR1xfA089DxI5kecApB5V0kG5wpw5HZjyhbXIOwlxXvREGQkRV0l5RTLb5dwt69W1fBJuxM4MUXKGGUKGK46Pdfhj63PAqJwqOOWNZZZHzSzi2F4A3dFmQ=
  - CURRENT_FLOODS_BRANCH_NAME=reset-password
  - S3_BUCKET=ctxfloods-frontend-reset-password
